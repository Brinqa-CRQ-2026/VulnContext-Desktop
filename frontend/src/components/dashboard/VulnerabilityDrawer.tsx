// src/components/dashboard/VulnerabilityDrawer.tsx
import React from "react";
import { ScoredFinding } from "../../api";

interface VulnerabilityDrawerProps {
  finding: ScoredFinding | null;
  onClose: () => void;
}

export function VulnerabilityDrawer({ finding, onClose }: VulnerabilityDrawerProps) {
  if (!finding) return null;

  const {
    finding_id,
    asset_id,
    hostname,
    ip_address,
    operating_system,
    asset_type,
    cve_id,
    cwe_id,
    description,
    cvss_score,
    cvss_severity,
    epss_score,
    attack_vector,
    privileges_required,
    user_interaction,
    vector_string,
    vuln_published_date,
    vuln_age_days,
    port,
    service,
    internet_exposed,
    auth_required,
    detection_method,
    first_detected,
    last_detected,
    times_detected,
    risk_score,
    risk_band,
  } = finding;

  const bandColorClass = (band: string) => {
    const b = band.toLowerCase();
    if (b === "critical") return "bg-rose-100 text-rose-700";
    if (b === "high") return "bg-orange-100 text-orange-700";
    if (b === "medium") return "bg-amber-100 text-amber-700";
    if (b === "low") return "bg-emerald-100 text-emerald-700";
    return "bg-slate-100 text-slate-700";
  };

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 z-40 bg-black/30"
        onClick={onClose}
      />

      {/* Drawer */}
      <aside className="fixed inset-y-0 right-0 z-50 w-full max-w-md bg-white shadow-xl">
        <div className="flex items-start justify-between border-b px-4 py-3">
          <div>
            <div className="text-xs font-semibold text-slate-500">
              FINDING {finding_id} • {asset_id}
            </div>
            <div className="mt-1 text-sm font-semibold text-slate-900">
              {cve_id || "Unspecified vulnerability"}
            </div>
            {hostname && (
              <div className="text-xs text-slate-500">
                {hostname} ({ip_address})
              </div>
            )}
          </div>
          <button
            onClick={onClose}
            className="rounded-full px-2 py-1 text-xs text-slate-500 hover:bg-slate-100"
          >
            Close
          </button>
        </div>

        <div className="flex flex-col gap-4 overflow-y-auto px-4 py-3 text-xs text-slate-700">
          {/* Risk summary pill */}
          <div className="flex items-center gap-2">
            <span
              className={
                "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold " +
                bandColorClass(risk_band)
              }
            >
              {risk_band} • {risk_score.toFixed(1)}
            </span>
            <span className="text-[11px] text-slate-500">
              CVSS {cvss_score.toFixed(1)}{cvss_severity ? ` (${cvss_severity})` : ""} • EPSS {epss_score.toFixed(4)}
            </span>
          </div>

          {/* Description */}
          {description && (
            <section>
              <div className="mb-1 font-semibold text-slate-800">
                Description
              </div>
              <p className="whitespace-pre-wrap text-[11px] leading-snug">
                {description}
              </p>
            </section>
          )}

          {/* Vulnerability details */}
          <section>
            <div className="mb-1 font-semibold text-slate-800">
              Vulnerability details
            </div>
            <dl className="grid grid-cols-2 gap-x-4 gap-y-1">
              <dt className="text-slate-500">CVE</dt>
              <dd>{cve_id || "—"}</dd>

              <dt className="text-slate-500">CWE</dt>
              <dd>{cwe_id || "—"}</dd>

              <dt className="text-slate-500">Attack vector</dt>
              <dd>{attack_vector || "—"}</dd>

              <dt className="text-slate-500">Privileges required</dt>
              <dd>{privileges_required || "—"}</dd>

              <dt className="text-slate-500">User interaction</dt>
              <dd>{user_interaction || "—"}</dd>

              <dt className="text-slate-500">Published</dt>
              <dd>{vuln_published_date || "—"}</dd>

              <dt className="text-slate-500">Age (days)</dt>
              <dd>{vuln_age_days ?? "—"}</dd>

              <dt className="text-slate-500">Times detected</dt>
              <dd>{times_detected ?? "—"}</dd>
            </dl>
          </section>

          {/* Asset & exposure */}
          <section>
            <div className="mb-1 font-semibold text-slate-800">
              Asset & exposure
            </div>
            <dl className="grid grid-cols-2 gap-x-4 gap-y-1">
              <dt className="text-slate-500">Hostname</dt>
              <dd>{hostname || "—"}</dd>

              <dt className="text-slate-500">IP address</dt>
              <dd>{ip_address || "—"}</dd>

              <dt className="text-slate-500">OS</dt>
              <dd>{operating_system || "—"}</dd>

              <dt className="text-slate-500">Asset type</dt>
              <dd>{asset_type || "—"}</dd>

              <dt className="text-slate-500">Port / service</dt>
              <dd>
                {port ?? "—"}
                {service ? ` (${service})` : ""}
              </dd>

              <dt className="text-slate-500">Internet exposed</dt>
              <dd>{internet_exposed ? "Yes" : "No"}</dd>

              <dt className="text-slate-500">Auth required</dt>
              <dd>{auth_required ? "Yes" : "No"}</dd>

              <dt className="text-slate-500">Detection method</dt>
              <dd>{detection_method || "—"}</dd>

              <dt className="text-slate-500">First detected</dt>
              <dd>{first_detected || "—"}</dd>

              <dt className="text-slate-500">Last detected</dt>
              <dd>{last_detected || "—"}</dd>
            </dl>
          </section>

          {/* CVSS vector */}
          {vector_string && (
            <section>
              <div className="mb-1 font-semibold text-slate-800">
                CVSS vector
              </div>
              <div className="rounded bg-slate-100 px-2 py-1 font-mono text-[11px]">
                {vector_string}
              </div>
            </section>
          )}
        </div>
      </aside>
    </>
  );
}