import React, { useEffect, useState } from "react";
import {
  clearFindingDisposition,
  FindingDisposition,
  FindingDispositionResult,
  ScoredFinding,
  setFindingDisposition,
} from "../../api";
import { Card, CardContent, CardHeader, CardTitle } from "../ui/card";
import { Button } from "../ui/button";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "../ui/sheet";

interface VulnerabilityDrawerProps {
  finding: ScoredFinding | null;
  onClose: () => void;
  onFindingUpdated?: () => void;
}

const DISPOSITION_OPTIONS: Array<{
  value: Exclude<FindingDisposition, "none">;
  label: string;
}> = [
  { value: "ignored", label: "Ignored" },
  { value: "risk_accepted", label: "Risk Accepted" },
  { value: "false_positive", label: "False Positive" },
  { value: "not_applicable", label: "Not Applicable" },
];

function toDateTimeLocalValue(value?: string | null): string {
  if (!value) return "";
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return "";
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  const hh = String(date.getHours()).padStart(2, "0");
  const mm = String(date.getMinutes()).padStart(2, "0");
  return `${y}-${m}-${d}T${hh}:${mm}`;
}

export function VulnerabilityDrawer({
  finding,
  onClose,
  onFindingUpdated,
}: VulnerabilityDrawerProps) {
  const [localFinding, setLocalFinding] = useState<ScoredFinding | null>(finding);
  const [dispositionDraft, setDispositionDraft] =
    useState<Exclude<FindingDisposition, "none">>("ignored");
  const [reasonDraft, setReasonDraft] = useState("");
  const [commentDraft, setCommentDraft] = useState("");
  const [expiresAtDraft, setExpiresAtDraft] = useState("");
  const [savingDisposition, setSavingDisposition] = useState(false);
  const [dispositionError, setDispositionError] = useState<string | null>(null);

  useEffect(() => {
    setLocalFinding(finding);
    if (!finding) {
      setDispositionError(null);
      setSavingDisposition(false);
      return;
    }
    const current = finding.disposition;
    setDispositionDraft(current && current !== "none" ? current : "ignored");
    setReasonDraft(finding.disposition_reason ?? "");
    setCommentDraft(finding.disposition_comment ?? "");
    setExpiresAtDraft(toDateTimeLocalValue(finding.disposition_expires_at));
    setDispositionError(null);
  }, [finding]);

  const bandColorClass = (band: string) => {
    const b = band.toLowerCase();
    if (b === "critical") return "border-rose-200 bg-rose-50 text-rose-700";
    if (b === "high") return "border-orange-200 bg-orange-50 text-orange-700";
    if (b === "medium") return "border-amber-200 bg-amber-50 text-amber-700";
    if (b === "low") return "border-emerald-200 bg-emerald-50 text-emerald-700";
    return "border-slate-200 bg-slate-50 text-slate-700";
  };

  const metaBadge = (label: string, tone: "neutral" | "success" | "warn" = "neutral") => {
    const toneClass =
      tone === "success"
        ? "border-emerald-200 bg-emerald-50 text-emerald-700"
        : tone === "warn"
          ? "border-amber-200 bg-amber-50 text-amber-700"
          : "border-slate-200 bg-slate-50 text-slate-700";
    return (
      <span
        className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium ${toneClass}`}
      >
        {label}
      </span>
    );
  };

  if (!finding) {
    return (
      <Sheet open={false} onOpenChange={(open) => !open && onClose()}>
        <SheetContent side="right" className="w-full sm:max-w-2xl" />
      </Sheet>
    );
  }

  const activeFinding = localFinding ?? finding;
  if (!activeFinding) {
    return null;
  }

  const {
    id,
    finding_id,
    asset_id,
    source,
    hostname,
    ip_address,
    operating_system,
    asset_type,
    cve_id,
    cwe_id,
    description,
    cvss_score,
    cvss_severity,
    epss_score,
    attack_vector,
    privileges_required,
    user_interaction,
    vector_string,
    vuln_published_date,
    vuln_age_days,
    port,
    service,
    internet_exposed,
    auth_required,
    detection_method,
    first_detected,
    last_detected,
    times_detected,
    risk_score,
    risk_band,
    lifecycle_status,
    disposition,
    disposition_state,
    disposition_reason,
    disposition_comment,
    disposition_created_at,
    disposition_expires_at,
    disposition_created_by,
  } = activeFinding;

  const applyDispositionToLocalFinding = (result: FindingDispositionResult) => {
    setLocalFinding((prev) =>
      prev
        ? {
            ...prev,
            disposition: result.disposition,
            disposition_state: result.disposition_state ?? null,
            disposition_reason: result.disposition_reason ?? null,
            disposition_comment: result.disposition_comment ?? null,
            disposition_created_at: result.disposition_created_at ?? null,
            disposition_expires_at: result.disposition_expires_at ?? null,
            disposition_created_by: result.disposition_created_by ?? null,
          }
        : prev
    );
  };

  const handleSaveDisposition = async () => {
    try {
      setSavingDisposition(true);
      setDispositionError(null);
      const result = await setFindingDisposition(id, {
        disposition: dispositionDraft,
        reason: reasonDraft.trim() || null,
        comment: commentDraft.trim() || null,
        expires_at: expiresAtDraft ? new Date(expiresAtDraft).toISOString() : null,
        actor: "ui",
      });
      applyDispositionToLocalFinding(result);
      onFindingUpdated?.();
    } catch (err) {
      console.error(err);
      setDispositionError(
        err instanceof Error ? err.message : "Failed to update disposition."
      );
    } finally {
      setSavingDisposition(false);
    }
  };

  const handleClearDisposition = async () => {
    try {
      setSavingDisposition(true);
      setDispositionError(null);
      const result = await clearFindingDisposition(id, "ui");
      applyDispositionToLocalFinding(result);
      setReasonDraft("");
      setCommentDraft("");
      setExpiresAtDraft("");
      onFindingUpdated?.();
    } catch (err) {
      console.error(err);
      setDispositionError(
        err instanceof Error ? err.message : "Failed to clear disposition."
      );
    } finally {
      setSavingDisposition(false);
    }
  };

  const DetailRow = ({
    label,
    value,
  }: {
    label: string;
    value: React.ReactNode;
  }) => (
    <div className="grid grid-cols-[9rem_minmax(0,1fr)] items-start gap-3 py-1.5 text-sm">
      <div className="text-slate-500">{label}</div>
      <div className="min-w-0 break-words text-slate-900">{value ?? "—"}</div>
    </div>
  );

  return (
    <Sheet open={Boolean(finding)} onOpenChange={(open) => !open && onClose()}>
      <SheetContent side="right" className="w-full sm:max-w-2xl">
        <div className="flex h-full flex-col bg-neutral-50">
          <div className="border-b border-slate-200 bg-white px-5 py-4">
            <SheetHeader>
              <div className="flex flex-wrap items-center gap-2 pr-10">
                <SheetTitle>{cve_id || "Unspecified vulnerability"}</SheetTitle>
                <span
                  className={
                    "inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold " +
                    bandColorClass(risk_band)
                  }
                >
                  {risk_band}
                </span>
                {source && metaBadge(source)}
                {lifecycle_status ? metaBadge(`Lifecycle: ${lifecycle_status}`) : null}
                {disposition && disposition !== "none"
                  ? metaBadge(`Disposition: ${disposition.replaceAll("_", " ")}`, "warn")
                  : null}
              </div>
              <SheetDescription>
                Finding {finding_id} on asset {asset_id}
                {hostname ? ` • ${hostname}${ip_address ? ` (${ip_address})` : ""}` : ""}
              </SheetDescription>
            </SheetHeader>
          </div>

          <div className="flex-1 space-y-4 overflow-y-auto p-5">
            <div className="grid gap-3 sm:grid-cols-3">
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    Risk Score
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-semibold text-slate-900">
                    {risk_score.toFixed(1)}
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    CVSS
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-1">
                  <div className="text-2xl font-semibold text-slate-900">
                    {cvss_score.toFixed(1)}
                  </div>
                  <div className="text-xs text-slate-500">{cvss_severity || "Unspecified"}</div>
                </CardContent>
              </Card>
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    EPSS
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-semibold text-slate-900">
                    {epss_score.toFixed(4)}
                  </div>
                </CardContent>
              </Card>
            </div>

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm">Disposition / Exception</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="grid gap-3 sm:grid-cols-2">
                  <label className="space-y-1 text-sm">
                    <span className="text-slate-600">Disposition</span>
                    <select
                      className="h-9 w-full rounded-md border border-slate-300 bg-white px-3 text-sm"
                      value={dispositionDraft}
                      onChange={(e) =>
                        setDispositionDraft(
                          e.target.value as Exclude<FindingDisposition, "none">
                        )
                      }
                      disabled={savingDisposition}
                    >
                      {DISPOSITION_OPTIONS.map((option) => (
                        <option key={option.value} value={option.value}>
                          {option.label}
                        </option>
                      ))}
                    </select>
                  </label>

                  <label className="space-y-1 text-sm">
                    <span className="text-slate-600">Expires (optional)</span>
                    <input
                      type="datetime-local"
                      className="h-9 w-full rounded-md border border-slate-300 bg-white px-3 text-sm"
                      value={expiresAtDraft}
                      onChange={(e) => setExpiresAtDraft(e.target.value)}
                      disabled={savingDisposition}
                    />
                  </label>
                </div>

                <label className="space-y-1 text-sm">
                  <span className="text-slate-600">Reason (optional)</span>
                  <input
                    type="text"
                    className="h-9 w-full rounded-md border border-slate-300 bg-white px-3 text-sm"
                    placeholder="e.g. compensating_control, accepted_by_team"
                    value={reasonDraft}
                    onChange={(e) => setReasonDraft(e.target.value)}
                    disabled={savingDisposition}
                  />
                </label>

                <label className="space-y-1 text-sm">
                  <span className="text-slate-600">Comment (optional)</span>
                  <textarea
                    className="min-h-[84px] w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                    placeholder="Why this is being ignored/accepted/marked false positive..."
                    value={commentDraft}
                    onChange={(e) => setCommentDraft(e.target.value)}
                    disabled={savingDisposition}
                  />
                </label>

                <div className="rounded-md border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
                  <div className="font-medium text-slate-700">Current state</div>
                  <div className="mt-1">
                    {disposition && disposition !== "none"
                      ? `${disposition.replaceAll("_", " ")}${
                          disposition_state ? ` (${disposition_state})` : ""
                        }`
                      : "No manual disposition"}
                  </div>
                  {(disposition_reason || disposition_comment || disposition_created_by) && (
                    <div className="mt-1 space-y-1">
                      {disposition_reason ? <div>Reason: {disposition_reason}</div> : null}
                      {disposition_created_by ? <div>By: {disposition_created_by}</div> : null}
                      {disposition_created_at ? (
                        <div>Updated: {new Date(disposition_created_at).toLocaleString()}</div>
                      ) : null}
                      {disposition_expires_at ? (
                        <div>Expires: {new Date(disposition_expires_at).toLocaleString()}</div>
                      ) : null}
                      {disposition_comment ? (
                        <div className="whitespace-pre-wrap">Comment: {disposition_comment}</div>
                      ) : null}
                    </div>
                  )}
                </div>

                {dispositionError ? (
                  <div className="text-xs text-rose-600">{dispositionError}</div>
                ) : null}

                <div className="flex flex-wrap gap-2">
                  <Button
                    size="sm"
                    onClick={handleSaveDisposition}
                    disabled={savingDisposition}
                  >
                    {savingDisposition ? "Saving..." : "Save Disposition"}
                  </Button>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={handleClearDisposition}
                    disabled={savingDisposition || !disposition || disposition === "none"}
                  >
                    Clear
                  </Button>
                </div>
              </CardContent>
            </Card>

            {description && (
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm">Description</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="whitespace-pre-wrap text-sm leading-6 text-slate-700">
                    {description}
                  </p>
                </CardContent>
              </Card>
            )}

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm">Vulnerability Details</CardTitle>
              </CardHeader>
              <CardContent className="divide-y divide-slate-100">
                <DetailRow label="CVE" value={cve_id || "—"} />
                <DetailRow label="CWE" value={cwe_id || "—"} />
                <DetailRow label="Attack vector" value={attack_vector || "—"} />
                <DetailRow label="Privileges" value={privileges_required || "—"} />
                <DetailRow label="User interaction" value={user_interaction || "—"} />
                <DetailRow label="Published" value={vuln_published_date || "—"} />
                <DetailRow label="Age (days)" value={vuln_age_days ?? "—"} />
                <DetailRow label="Times detected" value={times_detected ?? "—"} />
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm">Asset & Exposure</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex flex-wrap gap-2">
                  {metaBadge(internet_exposed ? "Internet Exposed" : "Internal", internet_exposed ? "warn" : "neutral")}
                  {metaBadge(auth_required ? "Auth Required" : "No Auth Required", auth_required ? "neutral" : "success")}
                  {asset_type ? metaBadge(asset_type) : null}
                  {detection_method ? metaBadge(detection_method) : null}
                </div>
                <div className="divide-y divide-slate-100">
                  <DetailRow label="Hostname" value={hostname || "—"} />
                  <DetailRow label="IP address" value={ip_address || "—"} />
                  <DetailRow label="Operating system" value={operating_system || "—"} />
                  <DetailRow
                    label="Port / Service"
                    value={
                      port || service ? `${port ?? "—"}${service ? ` (${service})` : ""}` : "—"
                    }
                  />
                  <DetailRow label="First detected" value={first_detected || "—"} />
                  <DetailRow label="Last detected" value={last_detected || "—"} />
                </div>
              </CardContent>
            </Card>

            {vector_string && (
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm">CVSS Vector</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 font-mono text-xs text-slate-700">
                    {vector_string}
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}
